---
title: "stdmodsem"
author: "Shu Fai Cheung"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    number_sections: true
vignette: >
  %\VignetteIndexEntry{stdmodsem}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
if (basename(getwd()) == "stdmodsem") {
    pth <- "./vignettes/"
  } else {
    pth <- "./"
  }
```

# Introduction

This article is a brief illustration on how `stdmodsem` functions are
used in some typical cases.

# Moderated Mediation by Regression

This is the sample dataset comes with the package:

```{r}
library(stdmodsem)
dat <- data_med_mod_ab
print(head(dat), digits = 3)
```

Suppose this is the model being fitted:

```{r echo = FALSE}
library(semPlot)
suppressMessages(library(lavaan))
dat$xw1 <- dat$x * dat$w1
dat$mw2 <- dat$m * dat$w2
mod <-
"
xw1 ~ x + w1
m ~ xw1
mw2 ~ m + w2
y ~ mw2
y ~ x
"
fit0 <- sem(mod, dat, do.fit = FALSE, fixed.x = FALSE)
layout_m <- matrix(c("w1", NA, NA, NA, "w2",
                   NA, NA, "m", NA, NA,
                   NA, "xw1", NA, "mw2", NA,
                   "x", NA, NA, NA, "y"), 4, 5, byrow = TRUE)
p <- semPaths(fit0,
              layout = layout_m,
              nCharNodes = 0,
              exoCov = FALSE,
              residuals = FALSE,
              sizeMan = 10,
              asize = 10,
              DoNotPlot = TRUE)
p$graphAttributes$Nodes$width[c(1, 3)] <- .01
p$graphAttributes$Nodes$height[c(1, 3)] <- .01
p$graphAttributes$Edges$asize[c(1, 4)] <- 0
plot(p)
```

## Estimating the Coefficients

This is a moderated mediation model with

  - a mediation path `x -> m -> y`, and

  - two moderators: `x -> m` moderated by `w1` and `m -> y` moderated by `w2`.

The effects of interest are the *conditional
indirect effects*: the indirect effects from `x` to `y` through `m` for
different levels of `w1` and `w2`.

The effects in this moderated mediation model can be
estimated by multiple regression approach in R using
`lm()`.

First, `m` is regressed on `x`, `w1`, and their interaction:

```{r}
lm_m <- lm(m ~ x * w1, dat)
```

Second, `y` is regressed on `m`, `w2`, their interaction, and `x`:

```{r}
lm_y <- lm(y ~ m * w2 + x, dat)
```

These are the coefficients:

```{r}
printCoefmat(summary(lm_m)$coefficients, digits = 3, signif.legend = FALSE)
printCoefmat(summary(lm_y)$coefficients, digits = 3, signif.legend = FALSE)
```

Both moderation effects are significant. Because the indirect effect
is moderated on both stages (`x -> m` and `m -> y`), the magnitude
of the indirect effect depends on `w1` and `w2`. The indirect
effect conditional on the moderators is called the *conditional*
*indirect* *effect*. Moreover, like a mediation effect without moderation,
its confidence interval can be formed by nonparametric bootstrapping.

To compute conditional indirect effects and form bootstrap confidence
intervals, we can use `cond_indirect_effects()`.

## Estimating Conditional Indirect Effects

This is the call to compute the conditional indirect effects:

```{r}
out_lm <- cond_indirect_effects(wlevels =c("w1", "w2"),
                                x = "x",
                                y = "y",
                                m = "m",
                                fit = list(lm_m, lm_y),
                                boot_ci = TRUE,
                                R = 500,
                                seed = 43143)
```

These are the major arguments:

- `wlevels`: The vector of the names of the moderators.
- `x`: The name of the predictor.
- `y`: The name of the outcome variable.
- `m`: The name of the mediator.
- `fit`: The list of the output of `lm()`.
- `boot_ci`: Set to `TRUE` to request bootstrapping confidence intervals.
             Default is `FALSE`.
- `R`: The number of bootstrap samples. Only 500 bootstrap samples
        for illustration. Set `R` to 2000 or even 5000 in real research.
- `seed`: The seed for the random number generator.

This is the output:

```{r}
out_lm
```

For two or more moderators, the default levels for numeric moderators
are one standard deviation below mean and one standard deviation above
mean. For two moderators, there are four combinations. As shown
above, among these levels, the indirect effect from `x` to `y` through
`m` is significant only when both `w1` and `w2` are one standard deviation
above mean. The indirect effect at these levels of `w1` and `w2` are
`r formatC(out_lm[1, "ind"], digits = 3, format = "f")`, with
95% bootstrap confidence interval
[`r paste0(formatC(unlist(out_lm[1, c("CI.lo", "CI.hi")]), digits = 3, format = "f"), collapse = ", ")`].

## Standardized Conditional Indirect Effects

To compute the conditional indirect effects, we can standardize
only the predictor (`x`), only the outcome (`y`), or both.

To standardize `x`, set `standardized_x` to `TRUE`. To standardize
`y`, set `standardized_y` to `TRUE`. To standardize both,
set both `standardized_x` and `standardized_y` to `TRUE`.

This is the result when both `x` and `y` are standardized:

```{r}
out_lm_stdxy <- cond_indirect_effects(wlevels =c("w1", "w2"),
                                x = "x",
                                y = "y",
                                m = "m",
                                fit = list(lm_m, lm_y),
                                boot_ci = TRUE,
                                R = 500,
                                seed = 43143,
                                standardized_x = TRUE,
                                standardized_y = TRUE)
out_lm_stdxy
```

The standardized indirect effect when both `w1` and `w2` are
one standard deviation above mean is
`r formatC(out_lm_stdxy[1, "std"], digits = 3, format = "f")`, with
95% bootstrap confidence interval
[`r paste0(formatC(unlist(out_lm_stdxy[1, c("CI.lo", "CI.hi")]), digits = 3, format = "f"), collapse = ", ")`].


# More Cases

# Further Information